<!--
 * @Author: 13594053100@163.com
 * @Date: 2025-11-25 13:46:04
 * @LastEditTime: 2025-11-27 15:44:23
-->
# JetLinksAI Video Inspection

å¤šè·¯è§†é¢‘æ™ºèƒ½å·¡æ£€ä¸ç¦»çº¿è§†é¢‘è§£æåç«¯æœåŠ¡ï¼Œæ”¯æŒ **RTSP å®æ—¶æµ** ä¸ **æœ¬åœ°éŸ³/è§†é¢‘æ–‡ä»¶**ï¼Œåœ¨ **è¾¹ç¼˜ç›’å­ï¼ˆSophon TPUï¼‰** æˆ–äº‘ç«¯è¿è¡Œ **VLM + ASR**ï¼Œè¾“å‡ºç»“æ„åŒ–å®‰é˜²äº‹ä»¶ä¸å¤šæ¨¡æ€æ‘˜è¦ï¼Œé€šè¿‡ **SSE** æ¨é€ç»™ä¸Šå±‚å¹³å°ã€‚

---

## ğŸš€ é¡¹ç›®å®šä½

ä½œä¸ºä¼ä¸šçº§ **ã€Œè§†é¢‘æ™ºèƒ½å·¡æ£€èƒ½åŠ›å±‚ã€**ï¼Œèšç„¦è§£å†³ï¼š

- å¤šè·¯ RTSP ç»Ÿä¸€ç®¡ç†ä¸è½®è¯¢å·¡æ£€
- è§†é¢‘æŒ‰æ—¶é—´çª—å£åˆ‡ç‰‡ + è‡ªé€‚åº”å…³é”®å¸§æŠ½å–
- æœ¬åœ°/äº‘ç«¯ VLM å®‰é˜²äº‹ä»¶æ£€æµ‹ä¸ç”»é¢ç†è§£
- æœ¬åœ°/äº‘ç«¯ ASR è¯­éŸ³è½¬å†™
- åˆ©ç”¨ç®—èƒ½è¾¹ç¼˜è®¡ç®—ç›’å­Sophon SDK éƒ¨ç½²çš„æœ¬åœ°Bmodelæ¨¡å‹, å®Œæˆè§†è§‰æè¿°ä¸å®‰é˜²ä»»åŠ¡

å…¸å‹åº”ç”¨ï¼šå·¥å‚ / å›­åŒº / æ¥¼å®‡å®‰é˜²å·¡æ£€ã€å¤§è§„æ¨¡å†å²è§†é¢‘ç¦»çº¿åˆ†æã€è¾¹ç¼˜ç«¯å¤šæ¨¡æ€æ¨ç†æœåŠ¡ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§ & æŠ€æœ¯äº®ç‚¹

- **å¤šè·¯ RTSP è½®è¯¢**
  - æ”¯æŒ **2â€“50 è·¯æ‘„åƒå¤´** è½®è¯¢
  - æ¯è·¯å¯ç‹¬ç«‹è®¾ç½® åˆ‡çª—ä¸ªæ•°ã€ç³»ç»Ÿæç¤ºè¯
  - è¿è¡Œæ—¶å¯åŠ¨æ€å¢åˆ æµã€è°ƒæ•´è½®è¯¢é—´éš”

- **å¤šæ¨¡æ€æµæ°´çº¿**
  - è§†é¢‘åˆ‡ç‰‡ + å…³é”®å¸§æŠ½å– â†’ VLM æ¨ç† â†’ ASR è½¬å†™
  - æ”¯æŒæœ¬åœ° Qwen-VLï¼ˆSophon TPUï¼‰ä¸äº‘ç«¯ VLM åˆ‡æ¢
  - æ”¯æŒæœ¬åœ° / äº‘ç«¯ ASRï¼Œç»Ÿä¸€è¾“å‡ºæ—¶åºæ–‡æœ¬

- **å®‰é˜²åœºæ™¯æŠ½è±¡**
  - å†…ç½® ç³»ç»Ÿæç¤ºè¯ï¼Œè¦†ç›– 10 ä¸ªå®‰é˜²/åˆè§„åœºæ™¯
  - æ¯ä¸ªåœºæ™¯ 3 æ¡ç›‘ç£ç›®æ ‡ï¼Œç»Ÿä¸€äº‹ä»¶ç»“æ„ä¸ä¸¥æ ¼JSONè¾“å‡ºæ ¼å¼

- **è‡ªé€‚åº”æ€§èƒ½è°ƒèŠ‚**
  - æœ¬åœ°å¤šæ¨¡æ€æ¨¡å‹è¿è¡Œæ—¶çŠ¶æ€æœºèƒ½å¤ŸåŸºäºæ¨ç†å»¶è¿Ÿè‡ªåŠ¨è°ƒæ•´ï¼š
    - åˆ‡ç‰‡çª—å£ `cut_window_sec`
    - è½®è¯¢é—´éš” `polling_batch_interval`
  - é¢å‘ç®—åŠ›å—é™è®¾å¤‡çš„ç¨³å®šè¿è¡Œèƒ½åŠ›

- **å·¥ç¨‹åŒ–ä¸æ‰©å±•æ€§**
  - åŸºäº FastAPI + Pydanticï¼Œé…ç½®ä¸¥æ ¼æ ¡éªŒ
  - å¤šé˜Ÿåˆ— + `_STOP` æ ‡è¯†çš„ Worker äº‹ä»¶æ€»çº¿åè°ƒï¼Œæ”¯æŒæš‚åœ/æ¢å¤/ä¼˜é›…é€€å‡º
  - SSE äº‹ä»¶æ€»çº¿æ˜“äºå¯¹æ¥å‰ç«¯ä¸ IoT å¹³å°

---

## ğŸ—ºï¸ æ¶æ„æ¦‚è§ˆ
![ç³»ç»Ÿæç®€æ¶æ„å›¾](./system_architecture.jpg)

## âš™ï¸ è¿è¡Œæ¨¡å¼
- OFFLINEï¼šç¦»çº¿éŸ³/è§†é¢‘è§£æ
- SECURITY_SINGLEï¼šå•è·¯ RTSP å¸¸é©»å®‰é˜²å·¡æ£€
- SECURITY_POLLINGï¼šå¤šæµRTSPè½®è¯¢å®‰é˜²å·¡æ£€

## ğŸ“¦ æµæ°´çº¿ä¸ Worker ç®€è¿°
æœ¬é¡¹ç›®å†…éƒ¨é‡‡ç”¨ã€Œä¸»æ§ + å¤š Workerã€çš„åˆ†å±‚æµæ°´çº¿æ¨¡å‹ï¼šç”± `StreamingAnalyze` ç»Ÿä¸€è´Ÿè´£è¾“å…¥æºç®¡ç†ã€é…ç½®åŠ è½½å’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼Œæ ¹æ®è¿è¡Œæ¨¡å¼ï¼ˆç¦»çº¿æ–‡ä»¶ / å•è·¯å®‰é˜² / å¤šè·¯è½®è¯¢ï¼‰æŒ‰éœ€å¯åŠ¨å„æ¡å¤„ç†é“¾è·¯ï¼Œå¹¶é€šè¿‡æœ‰ç•Œé˜Ÿåˆ—è§£è€¦æ¨¡å—ï¼Œé€šè¿‡ç»Ÿä¸€äº‹ä»¶æµå¯¹å¤–è¾“å‡ºç»“æœã€‚

- **A çº¿ï¼šåˆ‡ç‰‡ Workerï¼ˆ`worker_a_cut`ï¼‰**  
  ä» RTSP æˆ–æœ¬åœ°éŸ³è§†é¢‘æºè¯»å–æ•°æ®ï¼ŒæŒ‰ç…§é…ç½®çš„æ—¶é—´çª—å£è¿›è¡Œåˆ‡ç‰‡ï¼ŒæŠ½å–å…³é”®å¸§å¹¶æˆªå–å¯¹åº”éŸ³é¢‘ç‰‡æ®µï¼Œå°†ã€Œè§†é¢‘ä»»åŠ¡ã€å’Œã€ŒéŸ³é¢‘ä»»åŠ¡ã€åˆ†åˆ«æŠ•é€’åˆ°ä¸‹æ¸¸é˜Ÿåˆ—ã€‚è¯¥ Worker æ˜¯æ•´æ¡æµæ°´çº¿çš„ç”Ÿäº§è€…ï¼Œè´Ÿè´£è¡¥å…¨æ—¶é—´æˆ³ã€æµç¼–å·ã€è½®æ¬¡ç­‰å…ƒä¿¡æ¯ã€‚

- **B çº¿ï¼šVLM Workerï¼ˆ`worker_b_vlm`ï¼‰**  
  æ¶ˆè´¹è§†é¢‘ä»»åŠ¡ï¼Œè°ƒç”¨æœ¬åœ°æˆ–äº‘ç«¯å¤šæ¨¡æ€æ¨¡å‹ï¼Œå¯¹å…³é”®å¸§/ç”»é¢è¿›è¡Œç†è§£ä¸äº‹ä»¶è¯†åˆ«ã€‚æ”¯æŒæŒ‰æ¨¡å¼åˆ‡æ¢ç³»ç»Ÿæç¤ºè¯ï¼ˆç¦»çº¿åˆ†æ / å®‰é˜²åœºæ™¯ï¼‰ï¼Œè¾“å‡ºç»“æ„åŒ–å‘Šè­¦æˆ–æè¿°æ€§æ–‡æœ¬ï¼Œå¹¶å°†ç»“æœå†™å…¥ç»Ÿä¸€çš„ VLM äº‹ä»¶é˜Ÿåˆ—ï¼Œä¾›ä¸Šå±‚æœåŠ¡è®¢é˜…æˆ–è½åº“ã€‚

- **C çº¿ï¼šASR Workerï¼ˆ`worker_c_asr`ï¼‰**  
  æ¶ˆè´¹éŸ³é¢‘ä»»åŠ¡ï¼Œå¯¹å«è¯­éŸ³ç‰‡æ®µè¿›è¡Œè¯†åˆ«ä¸å¢é‡è½¬å†™ï¼Œå¯¹é™éŸ³ç‰‡æ®µè¿›è¡Œå¿«é€Ÿè¿‡æ»¤ã€‚æ”¯æŒæœ¬åœ°/äº‘ç«¯ ASR åç«¯ï¼Œè¾“å‡ºå¥çº§å¢é‡ç»“æœä¸åˆ‡ç‰‡çº§æœ€ç»ˆç»“æœï¼Œç»Ÿä¸€å†™å…¥ ASR äº‹ä»¶é˜Ÿåˆ—ã€‚

ä¸‰æ¡ Worker é€šè¿‡æ§åˆ¶é˜Ÿåˆ—æ¥æ”¶ `START/STOP` ç­‰æŒ‡ä»¤ï¼Œé€šè¿‡äº‹ä»¶é˜Ÿåˆ—å‘å¤–æš´éœ²æ ‡å‡†åŒ–çš„ VLM/ASR ç»“æœã€‚è¿™æ ·çš„è®¾è®¡æ—¢æ–¹ä¾¿åœ¨èµ„æºå—é™çš„è¾¹ç¼˜è®¾å¤‡ä¸ŠæŒ‰éœ€è£å‰ªæŸæ¡é“¾è·¯ï¼ˆä»…è§†é¢‘ / ä»…éŸ³é¢‘ï¼‰ï¼Œä¹Ÿä¾¿äºåç»­æ–°å¢å…¶å®ƒç±»å‹çš„ Worker åœ¨åŒä¸€æµæ°´çº¿ä¸ŠååŒå·¥ä½œã€‚

## ğŸ¤– æœ¬åœ°è¾¹ç¼˜æµ‹å¤šæ¨¡æ€æ¨¡å‹è¿è¡Œæ—¶çŠ¶æ€æœºç®€è¿°
åœ¨æœ¬åœ°è¾¹ç¼˜æµ‹å¤šæ¨¡æ€æ¨ç†é“¾è·¯ä¸Šå¼•å…¥äº†ä¸€ä¸ªè½»é‡çº§çš„è¿è¡Œæ—¶çŠ¶æ€æœº `LocalVlmRuntimeMachine`ï¼Œç”¨äºæ ¹æ® **å®é™… VLM æ¨ç†å»¶è¿Ÿ** åŠ¨æ€è°ƒæ•´åˆ‡ç‰‡çª—å£å’Œè½®è¯¢é—´éš”ï¼Œä»è€Œåœ¨è¾¹ç¼˜è®¾å¤‡ä¸Šå°½é‡åœ¨ã€Œå¯æ¥å—å»¶è¿Ÿã€ä¸ã€Œæœ‰é™ç®—åŠ›ã€ä¹‹é—´è‡ªåŠ¨å¯»ä¼˜ã€‚è¯¥çŠ¶æ€æœºä»…åœ¨å¯ç”¨äº†æœ¬åœ° VLM ä¸”é…ç½® `runtime_machine_config.local_vlm_runtime_machine = True` æ—¶ç”Ÿæ•ˆï¼Œåˆå§‹åŒ–å¤±è´¥æ—¶ä¼šè‡ªåŠ¨é™çº§ä¸ºæ™®é€šå›ºå®šé…ç½®æ¨¡å¼ã€‚

çŠ¶æ€æœºçš„æ ¸å¿ƒè¾“å…¥æ˜¯ Worker B äº§ç”Ÿçš„ `vlm_stream_done` äº‹ä»¶ä¸­çš„ `latency_ms` å­—æ®µï¼š  
å®ƒç»´æŠ¤ä¸€ä¸ªæ»‘åŠ¨çª—å£ç»Ÿè®¡å¹³å‡å»¶è¿Ÿï¼Œå¹¶æŒ‰ä¸€å®šäº‹ä»¶é—´éš”åšæ£€æŸ¥ï¼š
- è‹¥å¹³å‡å»¶è¿Ÿé•¿æœŸåé«˜ï¼ˆè¶…è¿‡ high / panic é˜ˆå€¼ï¼‰ï¼Œåˆ™ **æ”¾å®½é…ç½®**ï¼šé€‚åº¦å¢å¤§ `cut_window_sec`ï¼Œåœ¨è½®è¯¢æ¨¡å¼ä¸‹åŒæ—¶å¢å¤§ `polling_batch_interval`ï¼Œä»¥å‡å°‘å•ä½æ—¶é—´å†…çš„ VLM è°ƒç”¨é¢‘æ¬¡ã€é™ä½è´Ÿè½½ï¼›
- è‹¥å¹³å‡å»¶è¿ŸæŒç»­å¤„äºæ­£å¸¸ç”šè‡³åä½åŒºé—´ï¼Œåˆ™ **æ”¶ç´§é…ç½®**ï¼šåœ¨å®‰å…¨èŒƒå›´å†…å°† `cut_window_sec` / `polling_batch_interval` é€æ­¥æ‹‰å›åŸºç¡€å€¼ï¼Œæå‡æ—¶é—´åˆ†è¾¨ç‡ä¸å“åº”é€Ÿåº¦ï¼›
- é˜ˆå€¼å¯ç”±ä¸Šæ¸¸æ˜¾å¼é…ç½®ï¼Œä¹Ÿå¯åœ¨é‡‡é›†åˆ°ä¸€å®šæ•°é‡æ ·æœ¬åè‡ªåŠ¨ä¼°è®¡ï¼Œå†…éƒ¨å¸¦æœ‰ã€Œæœ€å°è°ƒæ•´é—´éš”ã€ã€Œç¡¬ä¸Šä¸‹é™ã€å’Œã€Œå¤šè½®ç¨³å®šå snap å›åŸºç¡€å€¼ã€ç­‰ä¿æŠ¤é€»è¾‘ï¼Œé¿å…é¢‘ç¹æŠ–åŠ¨ã€‚

## ğŸ§© è‡ªé€‚åº”å…³é”®å¸§æŠ½å–ç®—æ³•ç®€è¿°
æœ¬é¡¹ç›®çš„å…³é”®å¸§é€‰å–é€»è¾‘å°±åœ¨ `worker_a_cut.py` çš„ `pick_best_change_frame_with_pts` ä¸­å®ç°ã€‚å¯¹äºæ¯ä¸ªåˆ‡ç‰‡æ–‡ä»¶ `video_path`ï¼Œç®—æ³•ä¸ä¼šéå†æ‰€æœ‰å¸§ï¼Œè€Œæ˜¯æŒ‰æ­¥é•¿ `stride` åšå­é‡‡æ ·ï¼š

- è‹¥è§†é¢‘æ€»å¸§æ•°ä¸º `total`ï¼Œåˆ™ï¼š
  \[
  \text{stride} =
  \begin{cases}
  \max\bigl(1,\ \lfloor \text{total} / \text{EXPECT\_CANDS} \rfloor\bigr), & \text{total} > 0 \\
  \max\bigl(1,\ \text{round}(\text{fps} / 4)\bigr), & \text{total} = 0
  \end{cases}
  \]
  è¿™æ ·æ¯æ®µåˆ‡ç‰‡æœ€å¤šäº§ç”Ÿçº¦ `EXPECT_CANDS` ä¸ªå€™é€‰å¸§ã€‚

å¯¹æ¯ä¸ªè¢«é‡‡æ ·åˆ°çš„å¸§ï¼Œå…ˆç”¨ `resize_keep_w` å°†å®½åº¦ç¼©æ”¾åˆ°å›ºå®š `RESIZE_W`ï¼Œå¾—åˆ°å°å›¾ `small`ï¼Œå†è½¬ä¸ºç°åº¦ `gray`ã€‚ä»ç¬¬äºŒä¸ªå€™é€‰å¼€å§‹ï¼Œä¸å‰ä¸€ä¸ªå€™é€‰å¸§è®¡ç®—**ä¸¤ç±»å˜åŒ–é‡**ï¼š

1. **é¢œè‰²å˜åŒ–æ¯”ä¾‹ï¼ˆbgr_ratio_scoreï¼‰**  
   å¯¹ä¸¤å¸§ BGR å°å›¾ \(B^{(t-1)}, B^{(t)} \in \mathbb{R}^{H \times W \times 3}\)ï¼Œå®šä¹‰å·®åˆ†ï¼š
   \[
   D = |B^{(t)} - B^{(t-1)}|
   \]
   å°† \(D\) å±•å¹³æˆé•¿åº¦ä¸º \(3HW\) çš„å‘é‡ï¼Œè®°éé›¶å…ƒç´ ä¸ªæ•°ä¸º \(\text{nz}(D)\)ï¼Œåˆ™ï¼š
   \[
   \mathrm{bgr\_ratio\_score}
   = \frac{\text{nz}(D)}{3HW}
   \in [0, 1]
   \]
   è¶Šæ¥è¿‘ 1ï¼Œè¯´æ˜åƒç´ æœ‰å˜åŒ–çš„æ¯”ä¾‹è¶Šå¤§ï¼Œé¢œè‰²/çº¹ç†å˜åŒ–è¶Šæ˜æ˜¾ã€‚

2. **ç»“æ„ç›¸ä¼¼æ€§ï¼ˆssim_grayï¼‰**  
   å¯¹ä¸¤å¸§ç°åº¦å°å›¾ \(G^{(t-1)}, G^{(t)}\)ï¼ˆå¤§å°åŒä¸º \(H \times W\)ï¼‰ï¼Œå±•å¹³ä¸ºå‘é‡
   \[
   x, y \in \mathbb{R}^{N},\quad N = HW
   \]
   å®šä¹‰ï¼š
   \[
   \mu_x = \frac{1}{N}\sum_{i=1}^N x_i,\quad
   \mu_y = \frac{1}{N}\sum_{i=1}^N y_i
   \]
   \[
   \sigma_x^2 = \frac{1}{N}\sum_{i=1}^N (x_i - \mu_x)^2,\quad
   \sigma_y^2 = \frac{1}{N}\sum_{i=1}^N (y_i - \mu_y)^2
   \]
   \[
   \sigma_{xy} = \frac{1}{N}\sum_{i=1}^N (x_i - \mu_x)(y_i - \mu_y)
   \]
   ä»¤
   \[
   C_1 = (0.01 \times 255)^2,\quad
   C_2 = (0.03 \times 255)^2
   \]
   åˆ™æœ¬é¡¹ç›®å®ç°çš„ SSIM ä¸ºï¼š
   \[
   \mathrm{SSIM}(x, y)
   = \frac{(2\mu_x\mu_y + C_1)(2\sigma_{xy} + C_2)}
          {(\mu_x^2 + \mu_y^2 + C_1)(\sigma_x^2 + \sigma_y^2 + C_2)}
   \]
   å¹¶åœ¨ä»£ç ä¸­å°†å…¶è£å‰ªåˆ° \([0,1]\) åŒºé—´ï¼ˆè¶Šå¤§è¶Šç›¸ä¼¼ï¼‰ã€‚

ç»¼åˆä¸Šè¿°ä¸¤ä¸ªé‡ï¼Œå…³é”®å¸§çš„æ‰“åˆ†å‡½æ•°ä¸ºï¼š

\[
\begin{aligned}
\mathrm{score}^{(t)} 
&= \alpha_{\mathrm{bgr}} \cdot \mathrm{bgr\_ratio\_score}^{(t)}
  + (1 - \alpha_{\mathrm{bgr}}) \cdot \bigl(1 - \mathrm{SSIM}(G^{(t-1)}, G^{(t)})\bigr) \\
&= \alpha_{\mathrm{bgr}} \cdot R^{(t)}
  + (1 - \alpha_{\mathrm{bgr}})\biggl(1
  - \frac{(2\mu_x\mu_y + C_1)(2\sigma_{xy} + C_2)}
         {(\mu_x^2 + \mu_y^2 + C_1)(\sigma_x^2 + \sigma_y^2 + C_2)}\biggr)
\end{aligned}
\]

å…¶ä¸­ \(\alpha_{\mathrm{bgr}}\) å°±æ˜¯ `alpha_bgr` å‚æ•°ï¼ˆé»˜è®¤ 0.5ï¼‰ï¼Œæ§åˆ¶â€œé¢œè‰²å˜åŒ–æ¯”ä¾‹â€å’Œâ€œç»“æ„å˜åŒ–ç¨‹åº¦â€çš„æƒé‡ã€‚å¾—åˆ†è¶Šé«˜ï¼Œè¯´æ˜è¯¥å¸§ç›¸å¯¹ä¸Šä¸€å€™é€‰å¸§å˜åŒ–è¶Šæ˜æ˜¾ã€‚

ç®—æ³•ä¼šä¸ºæ¯ä¸ªå€™é€‰å¸§è®°å½•ï¼š

- å¸§ç´¢å¼• `cur_idx`ï¼›
- ç›¸å¯¹æ—¶é—´æˆ³ï¼š
  \[
  \text{pts} = \text{seg\_t0} + \frac{\text{cur\_idx}}{\text{fps}}
  \]
- åŸå§‹ BGR å¸§æ•°æ®ï¼ˆç”¨äºæœ€ç»ˆè½ç›˜ï¼‰ã€‚

æœ€ç»ˆæ­¥éª¤ï¼š

1. å¯¹æ‰€æœ‰å€™é€‰ `(score, cur_idx, pts, frame)` æŒ‰ `score` é™åºæ’åºï¼›
2. å–å‰ `topk_frames` ä¸ªï¼ˆé»˜è®¤ 1 ä¸ªï¼‰ï¼Œå†æŒ‰ `cur_idx` å‡åºæ’åºä¿è¯æ—¶é—´é¡ºåºï¼›
3. å°†é€‰ä¸­çš„å¸§å†™å…¥ `out_dir`ï¼Œæ–‡ä»¶ååŒ…å« `tag` å’Œå¸§å·ï¼Œè¿”å›ï¼š
   - å…³é”®å¸§è·¯å¾„åˆ—è¡¨ `paths`ï¼Œ
   - å¯¹åº” `pts` åˆ—è¡¨ï¼ˆç›¸å¯¹æ®µèµ·ç‚¹ç§’ï¼‰ï¼Œ
   - å¸§ç´¢å¼•åˆ—è¡¨ `idxs`ã€‚

åœ¨ `worker_a_cut` ä¸‹æ¸¸ï¼Œè¿™äº›ä¿¡æ¯ä¼šè¢«æ‰“åŒ…åˆ° `payload_video["keyframes"]`ã€`["frame_pts"]`ã€`["frame_indices"]` ç­‰å­—æ®µä¸­ï¼Œå¹¶åŒæ—¶æ¨ç®—å‡ºç»å¯¹æ—¶é—´æˆ³ï¼ˆepoch / ISOï¼‰ï¼Œä¾¿äº VLM Worker ç²¾ç¡®å¯¹é½ç”»é¢æ—¶åˆ»ã€‚




