<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JetLinksAI Â· RTSPå®‰é˜²ç›’å­ç‰ˆ Â· æ§åˆ¶å°</title>
<style>
  :root { --bg:#0b1116; --panel:#0f1720; --muted:#6b7280; --ok:#16a34a; --warn:#d97706; --err:#dc2626; --acc:#3b82f6; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:#e5e7eb; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif; }
  header { padding:16px 20px; border-bottom:1px solid #111827; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  header h1 { margin:0; font-size:16px; font-weight:600; }
  main { display:grid; grid-template-columns: 540px 1fr; gap:16px; padding:16px; }
  .card { background:var(--panel); border:1px solid #111827; border-radius:12px; padding:12px; }
  .card h2 { margin:0 0 10px; font-size:14px; font-weight:600; color:#cbd5e1; }
  .row { display:flex; gap:8px; align-items:center; margin:8px 0; }
  .row > label { min-width:140px; color:#cbd5e1; font-size:13px; line-height:1.4; }
  input[type="text"], input[type="number"], select, textarea {
    width:100%; padding:8px 10px; color:#e5e7eb; background:#0b1220; border:1px solid #172033; border-radius:8px; font-size:13px;
  }
  textarea.prompt { min-height: 120px; }
  button { padding:8px 12px; border:none; border-radius:8px; background:var(--acc); color:#fff; cursor:pointer; font-weight:600; font-size:13px; }
  button.secondary { background:#1f2937; color:#d1d5db; }
  button.ghost { background:transparent; border:1px dashed #334155; color:#9ca3af; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .muted { color:var(--muted); font-size:12px; line-height:1.4; }
  .ok { color:#86efac; font-size:12px; }
  .err { color:#fca5a5; font-size:12px; }
  .pill { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #172033; color:#9ca3af; font-size:12px; font-weight:500; }
  .hr { height:1px; background:#111827; margin:12px 0; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }

  /* è®© grid3 å†…çš„ .row ä½¿ç”¨ä¸¤åˆ—å¸ƒå±€ï¼Œé¿å…è¾“å…¥è¢«æŒ¤å‹åˆ° 0 å®½ */
  .grid3 .row {
    display: grid !important;
    grid-template-columns: 160px minmax(0,1fr);
    align-items: center;
    gap: 8px;
  }
  /* é˜²æ­¢æ§ä»¶è¢«å‹æ‰ */
  .row input, .row select, .row textarea { min-width: 0; }

  .right-col { display:flex; flex-direction:column; gap:12px; }
  .info { background:#0b1220; border:1px solid #172033; border-radius:10px; padding:10px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  .kv { display:flex; gap:6px; align-items:center; background:#0b1220; border:1px solid #172033; padding:6px 8px; border-radius:8px; font-size:12px; }
  .kv strong { color:#cbd5e1; }
  .legend { display:flex; gap:8px; flex-wrap:wrap; }
  .legend .kv { background:#0c1320; }

  .events { height:calc(100vh - 255px); overflow:auto; background:#0b1220; border:1px solid #172033; border-radius:10px; padding:10px; }

  /* SSE æ ‡é¢˜å³ä¾§è½®æ¬¡æ ‡ç­¾ */
  #sseRoundLabel { margin-left:8px; font-size:12px; color:#9ca3af; font-weight:400; }

  /* æ¯æ¡äº‹ä»¶ */
  .event-card {
    border:1px solid #273244;
    background:#0c1320;
    border-radius:10px;
    padding:12px;
    margin:12px 0;
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:12px;
  }
  .event-head { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
  .badge {
    display:inline-flex; align-items:center; gap:6px;
    padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700;
    background:rgba(59,130,246,.12); color:#93c5fd; border:1px solid rgba(59,130,246,.35);
  }
  .seg { color:#94a3b8; font-weight:600; font-size:12px; }
  .event-meta { margin-left:auto; font-size:12px; color:#94a3b8; display:flex; gap:10px; flex-wrap:wrap; line-height:1.4; }
  .event-desc { font-size:13px; color:#e5e7eb; line-height:1.6; white-space:pre-wrap; }
  .event-sugg { margin-top:6px; font-size:12px; color:#cbd5e1; line-height:1.4; }

  .badge-lvl { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; border:1px solidé€æ˜; line-height:1.3; }
  .lvl-low    { background:rgba(139,92,246,.12); color:#c4b5fd; border-color:rgba(139,92,246,.35); }
  .lvl-med    { background:rgba(217,119,6,.12);  color:#fdba74; border-color:rgba(217,119,6,.35); }
  .lvl-high   { background:rgba(239,68,68,.12);  color:#fca5a5; border-color:rgba(239,68,68,.45); }
  .lvl-crit   { background:rgba(153,27,27,.18);  color:#fecaca; border-color:rgba(153,27,27,.45); }
  .lvl-norisk {background:rgba(15,23,42,.6);color:#e5e7eb;border-color:#475569;}

  .evidence-wrap { display:grid; grid-template-columns: 1fr; gap:8px; align-content:start; }
  .evidence-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
  .evidence-item a { display:block; width:100%; }
  .evidence-item img { width:100%; height:150px; object-fit:cover; border-radius:8px; border:1px solid #172033; }

  /* è½®è¯¢æ¨¡å¼ä¸‹ï¼šæŒ‰æµåˆ’åˆ†çš„é¢æ¿ */
  .stream-panel {
    border:1px solid #1f2933;
    border-radius:10px;
    padding:8px;
    margin-bottom:10px;
    background:#020617;
  }
  .stream-panel-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
    font-size:12px;
    color:#9ca3af;
    gap:8px;
  }
  .stream-panel-title {
    font-weight:600;
    color:#e5e7eb;
  }
  .stream-panel-stat {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .stream-panel-stat span { white-space:nowrap; }
  .stream-panel-events { margin-top:4px; }

</style>
</head>
<body>
<header>
  <h1>JetLinksAI RTSPå®‰é˜² Â· æ§åˆ¶å°ğŸ¤–</h1>
  <span class="pill">RTSPå•æµå¸¸é©»ã€å¤šæµè½®è¯¢ã€å®æ—¶çƒ­æ›´æ–°ã€ç¦»çº¿éŸ³è§†é¢‘åˆ†æ</span>
</header>

<main>
  <!-- å·¦ä¾§ï¼šå¯åŠ¨ä¸æ§åˆ¶ -->
  <section class="card" style="max-height:calc(100vh - 64px); overflow:auto;">
    <h2>â‘  å¯åŠ¨ Â· security_single</h2>
    <form id="formSingle">
      <div class="row"><label>RTSP</label><input type="text" id="single_rtsp" placeholder="rtsp://user:pass@ip/..." required></div>
      <div class="row"><label>åˆ«åï¼ˆå‰ç«¯å±•ç¤ºï¼‰</label><input type="text" id="single_alias" placeholder="å¦‚ï¼šä¸œé—¨-001"></div>

      <div class="row"><label>æç¤ºè¯ï¼ˆè‡ªå®šä¹‰ï¼‰</label><input type="text" id="single_prompt" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸‹æ–¹é¢„è®¾"></div>

      <div class="row"><label>Preset</label>
        <select id="single_preset">
          <option value="FACTORY_SECURITY">å·¥å‚å®‰é˜²</option>
          <option value="RESIDENTIAL_SECURITY">å°åŒºå®‰é˜²</option>
          <option value="OFFICE_PRODUCTIVITY_COMPLIANT">åŠå…¬åŒºç§©åºä¸å ç”¨</option>
          <option value="CONSTRUCTION_PPE">æ–½å·¥ç°åœº PPE ä¸ä¸‰è¿</option>
          <option value="RETAIL_LOSS_PREVENTION">é›¶å”®é—¨åº— é˜²æŸä¸é™ˆåˆ—åˆè§„</option>
          <option value="TRAFFIC_INTERSECTION">äº¤é€šè·¯å£ æ€åŠ¿ä¸é£é™©</option>
          <option value="WAREHOUSE_SAFETY">ä»“å‚¨ä½œä¸š å®‰å…¨ä¸æ•ˆç‡</option>
          <option value="LAB_DATACENTER_SAFETY">å®éªŒå®¤ä¸æœºæˆ¿ å®‰å…¨åˆè§„</option>
          <option value="MANUFACTURING_QA">ç”Ÿäº§çº¿ å¤–è§‚è´¨æ£€ä¸å·¥ä½å¼‚å¸¸</option>
          <option value="HEALTHCARE_PUBLIC_SAFETY">åŒ»ç–—å…»è€æœºæ„ å…¬å…±å®‰å…¨</option>
        </select>
      </div>

      <div class="row"><label>æ¯è½®åˆ‡ç‰‡æ•°</label><input type="number" id="single_cutnum" min="1" max="10" value="1"></div>

      <div class="row"><label>åç«¯</label>
        <select id="single_backend">
          <option value="local">æœ¬åœ°</option>
          <option value="cloud" selected>äº‘ç«¯</option>
        </select>
      </div>

      <div class="row" id="rowSingleLocal">
        <label>æœ¬åœ°æ¨¡å‹</label>
        <select id="single_local_model">
          <option value="QWEN3_VL_4B" selected>QWEN3_VL_4B</option>
          <option value="QWEN3_VL_8B">QWEN3_VL_8B</option>
        </select>
      </div>
      <div class="row" id="rowSingleCloud" style="display:none;">
        <label>äº‘ç«¯æ¨¡å‹</label>
        <select id="single_cloud_model">
          <option value="QWEN3_VL_PLUS" selected>qwen3-vl-plus</option>
          <option value="QWEN_VL_MAX">qwen-vl-max</option>
          <option value="QWEN_VL_PLUS">qwen-vl-plus</option>
        </select>
      </div>

      <div class="row"><label>åŸºæœ¬åˆ‡çª—å¤§å°(s)</label>
        <input type="number" step="0.5" min="1" id="single_cutwin" value="4.0" inputmode="decimal">
      </div>
      <div class="row"><label>RGBé¢œè‰²å…³æ³¨æƒé‡ Î±</label>
        <input type="number" step="0.05" min="0" max="1" id="single_alpha" value="0.5" inputmode="decimal">
      </div>
      <div class="row"><label>å…³é”®å¸§æ•°é‡</label>
        <input type="number" id="single_topk" value="1" min="1" max="8" step="1" inputmode="numeric">
      </div>

      <div class="row"><label>æœ€å°äº‹ä»¶ç­‰çº§</label>
        <select id="single_minlvl">
          <option value="NO_RISK">æ— é£é™©</option>
          <option value="LOW" selected>ä½é£é™©</option>
          <option value="MEDIUM">ä¸­é£é™©</option>
          <option value="HIGH">é«˜é£é™©</option>
          <option value="CRITICAL">ä¸¥é‡é£é™©</option>
        </select>
      </div>
      <div class="row"><button type="submit">å¯åŠ¨ single</button></div>
    </form>

    <div class="hr"></div>

    <h2>â‘¡ å¯åŠ¨ Â· security_polling</h2>
    <div class="muted">è‡³å°‘ 2 è·¯ï¼›æ¯ä¸€è·¯éƒ½å¯ç‹¬ç«‹è‡ªå®šä¹‰æˆ–é€‰æ‹©é¢„è®¾ï¼›æ”¯æŒè¿è¡ŒæœŸå¢åˆ æ”¹ä¸æ”¹â€œè½®è¯¢é—´éš”â€ã€‚</div>
    <div id="pollingList"></div>
    <div class="grid3" style="margin:8px 0;">
      <button type="button" class="ghost" id="btnAddRow">+ æ–°å¢è·¯</button>
      <button type="button" class="ghost" id="btnDelLast">- åˆ é™¤æœ«å°¾</button>
      <button type="button" class="ghost" id="btnClearAll">æ¸…ç©º</button>
    </div>
    <form id="formPolling">
      <div class="row"><label>åç«¯</label>
        <select id="poll_backend">
          <option value="local">æœ¬åœ°</option>
          <option value="cloud" selected>äº‘ç«¯</option>
        </select>
      </div>
      <div class="row" id="rowPollLocal">
        <label>æœ¬åœ°æ¨¡å‹</label>
        <select id="poll_local_model">
          <option value="QWEN3_VL_4B" selected>QWEN3_VL_4B</option>
          <option value="QWEN3_VL_8B">QWEN3_VL_8B</option>
        </select>
      </div>
      <div class="row" id="rowPollCloud" style="display:none;">
        <label>äº‘ç«¯æ¨¡å‹</label>
        <select id="poll_cloud_model">
          <option value="QWEN3_VL_PLUS" selected>qwen3-vl-plus</option>
          <option value="QWEN_VL_MAX">qwen-vl-max</option>
          <option value="QWEN_VL_PLUS">qwen-vl-plus</option>
        </select>
      </div>

      <div class="row"><label>åŸºæœ¬åˆ‡çª—å¤§å°(s)</label>
        <input type="number" step="0.5" min="1" id="poll_cutwin" value="4.0" inputmode="decimal">
      </div>
      <div class="row"><label>RGBé¢œè‰²å…³æ³¨æƒé‡ Î±</label>
        <input type="number" step="0.05" min="0" max="1" id="poll_alpha" value="0.5" inputmode="decimal">
      </div>
      <div class="row"><label>å…³é”®å¸§æ•°é‡</label>
        <input type="number" id="poll_topk" value="1" min="1" max="8" step="1" inputmode="numeric">
      </div>

      <div class="row"><label>æœ€å°äº‹ä»¶ç­‰çº§</label>
        <select id="poll_minlvl">
          <option value="NO_RISK">æ— é£é™©</option>
          <option value="LOW" selected>ä½é£é™©</option>
          <option value="MEDIUM">ä¸­é£é™©</option>
          <option value="HIGH">é«˜é£é™©</option>
          <option value="CRITICAL">ä¸¥é‡</option>
        </select>
      </div>
      <div class="row"><label>è½®è¯¢é—´éš”(s â‰¥10)</label><input type="number" id="poll_interval" min="10" value="15" step="1" inputmode="numeric"></div>
      <div class="row"><button type="submit">å¯åŠ¨ polling</button></div>
    </form>

    <div class="hr"></div>

    <h2>â‘¢ ç¦»çº¿ Â· éŸ³è§†é¢‘</h2>
    <form id="formOffline">
      <div class="row"><label>ä¸Šä¼ æ–‡ä»¶</label><input type="file" id="off_file" accept=".mp4,.avi,.mkv,.mov,.flv,.mp3,.wav,.aac,.flac,.ogg"></div>
      <div class="row"><label>æˆ–æœ¬åœ°è·¯å¾„</label><input type="text" id="off_path" placeholder="/abs/path/to/media.[mp4|mp3]"></div>

      <!-- è§†é¢‘ä¸“ç”¨é…ç½®ï¼ˆéŸ³é¢‘æ—¶å¯å¿½ç•¥ï¼Œå‰ç«¯ä»ä¼šä¼  cut/alpha/topkï¼‰-->
      <div class="row"><label>ç³»ç»Ÿæç¤ºè¯ï¼ˆè§†é¢‘ï¼‰</label><input type="text" id="off_sys_prompt" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æè¿°æç¤ºè¯"></div>
      <div class="row"><label>åç«¯ï¼ˆè§†é¢‘ï¼‰</label>
        <select id="off_backend">
          <option value="local">æœ¬åœ°</option>
          <option value="cloud"selected>äº‘ç«¯</option>
        </select>
      </div>
      <div class="row" id="rowOffLocal">
        <label>æœ¬åœ°æ¨¡å‹</label>
        <select id="off_local_model">
          <option value="QWEN3_VL_4B" selected>QWEN3_VL_4B</option>
          <option value="QWEN3_VL_8B">QWEN3_VL_8B</option>
        </select>
      </div>
      <div class="row" id="rowOffCloud" style="display:none;">
        <label>äº‘ç«¯æ¨¡å‹</label>
        <select id="off_cloud_model">
          <option value="QWEN3_VL_PLUS" selected>qwen3-vl-plus</option>
          <option value="QWEN_VL_MAX">qwen-vl-max</option>
          <option value="QWEN_VL_PLUS">qwen-vl-plus</option>
        </select>
      </div>

      <div class="row"><label>åŸºæœ¬åˆ‡çª—å¤§å°(s)</label>
        <input type="number" step="0.5" min="1" id="off_cutwin" value="6.0" inputmode="decimal">
      </div>
      <div class="row"><label>RGBé¢œè‰²å…³æ³¨æƒé‡ Î±</label>
        <input type="number" step="0.05" min="0" max="1" id="off_alpha" value="0.5" inputmode="decimal">
      </div>
      <div class="row"><label>å…³é”®å¸§æ•°é‡</label>
        <input type="number" id="off_topk" value="3" min="1" max="8" step="1" inputmode="numeric">
      </div>

      <div class="row"><button type="submit">å¯åŠ¨ç¦»çº¿ä»»åŠ¡</button></div>
      <div class="muted">è¯´æ˜ï¼šè§†é¢‘ä¼šè§¦å‘ VLM è§†è§‰æè¿°ï¼ˆB çº¿ç¨‹ï¼‰ï¼›éŸ³é¢‘åªè§¦å‘ ASRï¼ˆC çº¿ç¨‹ï¼‰ã€‚</div>
    </form>

    <div class="hr"></div>

    <h2>â‘£ è¿è¡ŒæœŸæ§åˆ¶ Â· å½“å‰ Job</h2>
    <div class="row">
      <label>æ¿€æ´» Job</label>
      <select id="jobsSelect"></select>
      <button type="button" class="secondary" id="btnRefreshJobs">åˆ·æ–°</button>
    </div>
    <div class="grid3">
      <button type="button" class="secondary" id="btnPause">æš‚åœ</button>
      <button type="button" class="secondary" id="btnResume">æ¢å¤</button>
      <button type="button" class="secondary" id="btnStopJob">åœæ­¢Job</button>
    </div>

    <div class="hr"></div>

    <h2>â‘¤ è¿è¡ŒæœŸ Â· è½®è¯¢ä¸“ç”¨æ§åˆ¶</h2>
    <div class="row"><label>æ”¹è½®è¯¢é—´éš”(s â‰¥10)</label><input type="number" id="ctl_interval" min="10" value="15" step="1"><button type="button" id="btnSetInterval">è®¾ç½®</button></div>

    <div class="row"><label>æ–°å¢æµ</label></div>
    <div class="grid3">
      <input type="text" id="ctl_add_url" placeholder="rtsp://...">
      <input type="text" id="ctl_add_alias" placeholder="åˆ«å(å‰ç«¯)">
      <input type="text" id="ctl_add_prompt" placeholder="æç¤ºè¯ï¼ˆå¯å¡«é¢„è®¾åæˆ–è‡ªå®šä¹‰ï¼‰">
    </div>
    <div class="row"><label>æ¯è½®åˆ‡ç‰‡æ•°</label><input type="number" id="ctl_add_cutnum" min="1" max="10" value="1"><button type="button" id="btnAddStream">æ–°å¢</button></div>

    <div class="row"><label>åˆ é™¤æµï¼ˆæŒ‰URLï¼‰</label><input type="text" id="ctl_del_url" placeholder="rtsp://..."><button type="button" id="btnDelStream">åˆ é™¤</button></div>

    <div class="row"><label>æ›´æ–°æµï¼ˆå•/è½®è¯¢é€šç”¨ï¼‰</label></div>
    <div class="grid3">
      <input type="text" id="ctl_upd_old" placeholder="æ—§URLï¼ˆæˆ–ç•™ç©ºç”¨ç´¢å¼•ï¼‰">
      <input type="number" id="ctl_upd_idx" placeholder="ç´¢å¼•(å¯é€‰)" min="0" step="1">
      <input type="text" id="ctl_upd_newurl" placeholder="æ–°URL">
    </div>
    <div class="grid3">
      <input type="text" id="ctl_upd_alias" placeholder="æ–°åˆ«å(å‰ç«¯)">
      <input type="text" id="ctl_upd_prompt" placeholder="æ–°æç¤ºè¯ï¼ˆå¯å¡«é¢„è®¾åæˆ–è‡ªå®šä¹‰ï¼‰">
      <input type="number" id="ctl_upd_cutnum" placeholder="æ–°åˆ‡ç‰‡æ•°" min="1" max="10" step="1">
    </div>
    <div class="row"><button type="button" id="btnUpdStream">æ‰§è¡Œæ›´æ–°</button></div>

    <div class="hr"></div>
    <h2>â‘¥ ç»Ÿè®¡/å…¨åœ</h2>
    <div class="grid3">
      <button type="button" class="secondary" id="btnStats">è·å–ç»Ÿè®¡</button>
      <button type="button" class="secondary" id="btnResetStats">é‡ç½®ç»Ÿè®¡</button>
      <button type="button" class="secondary" id="btnStopAll">å…¨åœ</button>
    </div>

    <div class="hr"></div>
    <div class="muted" id="status"></div>
  </section>

  <!-- å³ä¾§ï¼šä¿¡æ¯æ¡ + äº‹ä»¶é¢æ¿ -->
  <section class="right-col">
    <div class="info" id="infoBar" style="display:none;">
      <div class="kv"><strong>Job</strong><span id="inf_job">â€”</span></div>
      <div class="kv"><strong>æ¨¡å¼</strong><span id="inf_mode">â€”</span></div>
      <div class="kv"><strong>è½®æ¬¡</strong><span id="inf_round">â€”</span></div>
      <div class="kv"><strong>è½®è¯¢é—´éš”</strong><span id="inf_interval">â€”</span></div>
      <div class="kv"><strong>çª—å£ç´¯è®¡</strong><span id="inf_windows">â€”</span></div>
      <div class="legend" id="legend"></div>
    </div>

    <div class="card">
      <h2>SSE å®æ—¶äº‹ä»¶ <span id="sseRoundLabel" class="muted"></span></h2>
      <div id="events" class="events"></div>
    </div>
  </section>
</main>

<script>
(() => {
  const $ = (s,p=document)=>p.querySelector(s);
  const statusEl = $("#status");
  const eventsEl = $("#events");
  const infoBar = $("#infoBar");
  const infJob = $("#inf_job"), infMode = $("#inf_mode"), infRound = $("#inf_round"),
        infInterval = $("#inf_interval"), infWindows = $("#inf_windows"), legend = $("#legend");
  const sseRoundLabel = $("#sseRoundLabel");

  // ======= çŠ¶æ€ =======  
  let es = null;
  let activeJobId = null;
  let activeMode = null;         // security_single / security_polling / offline-vision / offline-audio
  let pollingInterval = null;    // å½“å‰æ˜¾ç¤ºç”¨
  let latestRound = -1;          // è½®æ¬¡ï¼ˆ0-basedï¼‰
  let totalWindows = 0;          // å…¨å±€çª—å£è®¡æ•°
  let perStreamWindows = {};     // {stream_index: max(stream_segment_index+1)}
  let aliasMap = {};             // {rtsp_url: alias}
  let urlByStreamIndex = {};     // æ¸²æŸ“æ˜¾ç¤ºç”¨ {stream_index: url}
  let streamPanels = {};         // {stream_index: HTMLElement}

  // ç»Ÿä¸€åˆ¤æ–­æ˜¯å¦è½®è¯¢æ¨¡å¼ï¼šå…¼å®¹ security_polling / security-polling
  function isPollingMode(mode) {
    if (!mode) return false;
    const m = String(mode).toLowerCase().replace(/_/g, "-");
    return m.includes("security-polling");
  }

  function setStatus(msg, ok=true){
    statusEl.innerHTML = ok ? `<span class="ok">âœ… ${msg}</span>` : `<span class="err">âŒ ${msg}</span>`;
  }

  function renderInfoBar(){
    if (!activeJobId) {
      infoBar.style.display = "none";
      if (sseRoundLabel) sseRoundLabel.textContent = "";
      return;
    }
    infoBar.style.display = "";
    infJob.textContent = activeJobId;
    infMode.textContent = activeMode || "â€”";
    infRound.textContent = (latestRound>=0) ? String(latestRound+1) : "â€”";
    infInterval.textContent = (pollingInterval!=null) ? `${pollingInterval}s` : "â€”";
    infWindows.textContent = String(totalWindows);

    // é¡¶éƒ¨è½®æ¬¡æç¤º
    if (sseRoundLabel) {
      if (isPollingMode(activeMode) && latestRound >= 0) {
        sseRoundLabel.textContent = `å½“å‰è½®è¯¢è½®æ¬¡ï¼šç¬¬ ${latestRound+1} è½®`;
      } else {
        sseRoundLabel.textContent = "";
      }
    }

    legend.innerHTML = "";
    const idxs = Object.keys(urlByStreamIndex).map(x=>Number(x)).sort((a,b)=>a-b);
    idxs.forEach(i=>{
      const url = urlByStreamIndex[i];
      const alias = aliasMap[url] || url;
      const w = perStreamWindows[i] || 0;
      const div = document.createElement("div");
      div.className = "kv";
      div.innerHTML = `<strong>S${i}</strong><span>${alias}</span><span class="muted">ï¼ˆæ€»è§‚å¯Ÿçª—å£ ${w}ï¼‰</span>`;
      legend.appendChild(div);
    });
  }

  function clearRuntimeCounters(){
    latestRound = -1;
    totalWindows = 0;
    perStreamWindows = {};
    urlByStreamIndex = {};
    renderInfoBar();
  }

  function clearEvents(){
    eventsEl.innerHTML = "";
    streamPanels = {};
  }

  // ======= SSE =======  
  function closeSSE(){ if (es) { es.close(); es=null; } }

  function connectSSE(jobId){
    closeSSE();
    if (!jobId) return;
    es = new EventSource(`/events?job_id=${encodeURIComponent(jobId)}`);
    es.onmessage = (e)=>{
      let data; try { data = JSON.parse(e.data); } catch { return; }
      if (data.type === "vlm_done") {
        const si   = Number(data.stream_index ?? NaN);
        const round = Number(data.polling_round_index ?? NaN);
        const sseg = Number(data.stream_segment_index ?? NaN);
        const sUrl = String(data.stream_url ?? "");

        if (!Number.isNaN(si)) {
          urlByStreamIndex[si] = sUrl || (urlByStreamIndex[si] || "");
        }
        if (!Number.isNaN(si) && !Number.isNaN(sseg)) {
          const val = sseg + 1;
          perStreamWindows[si] = Math.max(perStreamWindows[si] || 0, val);
        }
        if (!Number.isNaN(round)) latestRound = Math.max(latestRound, round);

        totalWindows += 1;
        renderInfoBar();

        addEventCard(data);
      } else if (data.type === "asr_done") {
        addEventCard(data);
      }
    };
    es.onerror = ()=>setStatus("SSE è¿æ¥å‡ºé”™æˆ–ä¸­æ–­", false);
  }

  // ======= å·¥å…· =======  
  const fmtSec = (x)=> (x!=null && isFinite(Number(x))) ? `${Number(x).toFixed(2)}s` : "â€”";
  const levelMap = {
    NO_RISK:  { txt: "æ— é£é™©",   cls: "lvl-norisk" },
    LOW:      { txt: "ä½é£é™©",   cls: "lvl-low"  },
    MEDIUM:   { txt: "ä¸­é£é™©",   cls: "lvl-med"  },
    HIGH:     { txt: "é«˜é£é™©",   cls: "lvl-high" },
    CRITICAL: { txt: "ä¸¥é‡",     cls: "lvl-crit" },
  };
  const pct = (v)=> {
    const n = Number(v);
    return isFinite(n) ? `${Math.round(Math.max(0, Math.min(1, n))*100)}%` : "â€”";
  };
  function pick(obj, ...keys){ for (const k of keys){ const v=obj?obj[k]:undefined; if(v!==undefined && v!==null) return v; } }

  // è½®è¯¢æ¨¡å¼ä¸‹ï¼Œæ ¹æ® stream_index æ‰¾åˆ°/åˆ›å»ºå¯¹åº”çš„é¢æ¿å®¹å™¨
  function getStreamPanelContainer(sse){
    if (!isPollingMode(activeMode)) {
      return eventsEl;
    }
    const rawIdx = sse.stream_index;
    const idx = Number(rawIdx);
    if (!Number.isFinite(idx)) return eventsEl;

    let panel = streamPanels[idx];
    if (!panel || !panel.isConnected) {
      panel = document.createElement("div");
      panel.className = "stream-panel";
      panel.dataset.streamIndex = String(idx);

      const header = document.createElement("div");
      header.className = "stream-panel-header";

      const title = document.createElement("div");
      title.className = "stream-panel-title";
      header.appendChild(title);

      const stat = document.createElement("div");
      stat.className = "stream-panel-stat";
      stat.innerHTML = `
        <span>æ€»è§‚å¯Ÿçª—å£ï¼š<span class="val-total">0</span></span>
        <span>å½“å‰è½®æ¬¡è§‚å¯Ÿçª—å£ï¼š<span class="val-round">0</span></span>
      `;
      header.appendChild(stat);

      panel.appendChild(header);

      const evWrap = document.createElement("div");
      evWrap.className = "stream-panel-events";
      panel.appendChild(evWrap);

      // æŒ‰ stream_index æ’åºæ’å…¥
      const existing = [...eventsEl.querySelectorAll(".stream-panel")];
      const before = existing.find(n => Number(n.dataset.streamIndex) > idx);
      if (before) eventsEl.insertBefore(panel, before); else eventsEl.appendChild(panel);

      streamPanels[idx] = panel;
    }

    const url = sse.stream_url || "";
    const alias = aliasMap[url] || url || `S${idx}`;
    const titleEl = panel.querySelector(".stream-panel-title");
    if (titleEl) titleEl.textContent = `S${idx} Â· ${alias}`;

    const totalEl = panel.querySelector(".val-total");
    if (totalEl) totalEl.textContent = String(perStreamWindows[idx] || 0);

    const winIdx = Number(sse.window_index_in_stream ?? NaN);
    const roundEl = panel.querySelector(".val-round");
    if (roundEl && Number.isFinite(winIdx)) {
      roundEl.textContent = String(winIdx + 1);
    }

    return panel.querySelector(".stream-panel-events") || panel;
  }

  // ======= äº‹ä»¶å¡ç‰‡æ¸²æŸ“ =======  
  function addEventCard(sse){
    const container = getStreamPanelContainer(sse);

    const block = document.createElement("div");
    block.className = "event-card";

    const seg      = sse.segment_index ?? sse.seg ?? "â€”";
    const round    = (sse.polling_round_index!=null) ? sse.polling_round_index : "â€”";
    const sIdx     = (sse.stream_index!=null) ? sse.stream_index : "â€”";
    const sSeg     = (sse.stream_segment_index!=null) ? sse.stream_segment_index : "â€”";
    const winIdx   = (sse.window_index_in_stream!=null) ? sse.window_index_in_stream : "â€”";
    const t0       = pick(sse,"t0","clip_t0");
    const t1       = pick(sse,"t1","clip_t1");
    const url      = sse.stream_url || "";
    const alias    = aliasMap[url] || url || (sIdx!=="â€”" ? `S${sIdx}` : "");

    // å·¦åˆ—
    const left = document.createElement("div");
    const head = document.createElement("div");
    head.className = "event-head";
    const badgeTxt = (sse.type === "asr_done") ? "ASR âœ“" : "VLM âœ“";
    head.innerHTML = `<span class="badge">${badgeTxt}</span><span class="seg">seg#${seg}</span>`;
    const meta = document.createElement("div");
    meta.className = "event-meta";
    const parts = [];
    parts.push(`window [${fmtSec(t0)} ~ ${fmtSec(t1)}]`);
    if (isPollingMode(activeMode)) {
      parts.push(`S${sIdx} Â· ${alias}`);
      if (sSeg !== "â€”")   parts.push(`æ€»è§‚å¯Ÿçª—å£ #${Number(sSeg)+1}`);
      if (winIdx !== "â€”") parts.push(`å½“å‰è½®æ¬¡çª—å£ #${Number(winIdx)+1}`);
      if (round !== "â€”")  parts.push(`è½®è¯¢è½®æ¬¡ #${Number(round)+1}`);
    }
    meta.innerHTML = parts.map(x=>`<span>${x}</span>`).join("");
    head.appendChild(meta);
    left.appendChild(head);

    // å†…å®¹ï¼šç»“æ„åŒ–æ•°ç»„æˆ–çº¯æ–‡æœ¬
    const fullText = (sse.text ?? sse.full_text ?? "").trim();
    let arr = [];
    try { const tmp = JSON.parse(fullText); if (Array.isArray(tmp)) arr = tmp; } catch {}
    if (arr.length===0) {
      const row = document.createElement("div");
      row.className = "event-desc";
      row.textContent = fullText || "ï¼ˆæ— æ–°å¢ï¼‰";
      left.appendChild(row);
    } else {
      arr.forEach(it=>{
        const level = String(it.level||"").toUpperCase();
        const lv = levelMap[level] || levelMap.MEDIUM;
        const row = document.createElement("div");
        row.className = "event-desc";
        row.innerHTML = `${it.describe || "æ£€æµ‹åˆ°äº‹ä»¶"} <span class="badge-lvl ${lv.cls}">${lv.txt}</span> <span class="muted">ç½®ä¿¡åº¦ ${pct(it.confidence)}</span>`;
        left.appendChild(row);
        if (it.suggestion) {
          const sug = document.createElement("div");
          sug.className = "event-sugg";
          sug.textContent = `å»ºè®®ï¼š${it.suggestion}`;
          left.appendChild(sug);
        }
      });
    }

    // å³åˆ—è¯æ®
    const right = document.createElement("div");
    right.className = "evidence-wrap";
    const urls = (Array.isArray(sse.evidence_image_urls)&&sse.evidence_image_urls) || [];
    if (urls.length===0) {
      right.innerHTML = `<div class="muted" style="font-size:12px;text-align:center;">æ— è¯æ®å¸§</div>`;
    } else {
      const grid = document.createElement("div");
      grid.className = "evidence-grid";
      urls.forEach(u=>{
        const it = document.createElement("div");
        it.className="evidence-item";
        it.innerHTML = `<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="evidence"></a>`;
        grid.appendChild(it);
      });
      right.appendChild(grid);
    }

    block.appendChild(left);
    block.appendChild(right);
    container.appendChild(block);

    // æ»šåˆ°åº•
    eventsEl.scrollTop = eventsEl.scrollHeight;
  }

  // ======= Jobs =======  
  const jobsSelect = $("#jobsSelect");
  async function refreshJobs(selKeep=true){
    try{
      const r = await fetch("/jobs");
      const j = await r.json();
      if (!r.ok || !j.ok) throw new Error(j.error || "è·å– jobs å¤±è´¥");
      const prev = jobsSelect.value;
      jobsSelect.innerHTML = "";
      (j.jobs||[]).forEach(item=>{
        const opt = document.createElement("option");
        opt.value = item.job_id;
        opt.textContent = `${item.job_id} (${item.mode}${item.running?"/running":"/stopped"})`;
        opt.dataset.mode = item.mode;
        jobsSelect.appendChild(opt);
      });
      if (selKeep && prev && [...jobsSelect.options].some(o=>o.value===prev)) {
        jobsSelect.value = prev;
      } else if (jobsSelect.options.length>0) {
        jobsSelect.selectedIndex = 0;
      }
      onSelectJobChanged();
    }catch(e){ setStatus(e.message||"åˆ·æ–°å¤±è´¥", false); }
  }
  function onSelectJobChanged(){
    const opt = jobsSelect.options[jobsSelect.selectedIndex];
    activeJobId = opt ? opt.value : null;
    activeMode  = opt ? (opt.dataset.mode || "â€”") : null;
    clearRuntimeCounters();
    clearEvents();
    connectSSE(activeJobId);
    if (!isPollingMode(activeMode)) {
      pollingInterval = null;
    }
    renderInfoBar();
  }
  $("#btnRefreshJobs").addEventListener("click", ()=>refreshJobs(false));
  jobsSelect.addEventListener("change", onSelectJobChanged);

  // ======= å·¥å…·å‡½æ•° =======  
  function clampNumber(v, def, min, max){
    let n = Number(v);
    if (!Number.isFinite(n)) n = def;
    if (min!=null) n = Math.max(min, n);
    if (max!=null) n = Math.min(max, n);
    return n;
  }
  function detectMediaKindByName(name){
    const ext = String(name||"").split(".").pop().toLowerCase();
    const vids = ["mp4","avi","mkv","mov","flv"];
    const auds = ["mp3","wav","aac","flac","ogg"];
    return { isVideo: vids.includes(ext), isAudio: auds.includes(ext) };
  }
  function lockTopK(inputEl, isLocal){
    if (!inputEl) return;
    if (isLocal) {
      if (!inputEl.dataset.prev) inputEl.dataset.prev = inputEl.value || "1";
      inputEl.value = "1"; inputEl.min="1"; inputEl.max="1"; inputEl.step="1";
      inputEl.disabled=true; inputEl.title="æœ¬åœ°æ¨¡å‹å›ºå®š TopK=1";
    } else {
      inputEl.disabled=false; inputEl.min="1"; inputEl.max="8"; inputEl.step="1"; inputEl.title="";
      const prev = inputEl.dataset.prev;
      if (prev && prev !== "1") inputEl.value = prev;
    }
  }

  // ======= å•æµå¯åŠ¨ =======  
  $("#single_backend").addEventListener("change", (e)=>{
    const v = e.target.value;
    $("#rowSingleLocal").style.display = (v==="local")?"":"none";
    $("#rowSingleCloud").style.display = (v==="cloud")?"":"none";
    lockTopK($("#single_topk"), v==="local");
  });

  $("#formSingle").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const backend = $("#single_backend").value;

    // æ•°å€¼é’³åˆ¶
    const cutwin = clampNumber($("#single_cutwin").value, 4.0, 1, null);
    const alpha  = clampNumber($("#single_alpha").value, 0.5, 0, 1);
    const topk   = clampNumber($("#single_topk").value, 1, 1, null);

    const fd = new FormData();
    fd.append("rtsp_url", $("#single_rtsp").value.trim());
    fd.append("vlm_backend", backend);
    if (backend==="local") fd.append("local_model_name", $("#single_local_model").value);
    if (backend==="cloud") fd.append("cloud_model_name", $("#single_cloud_model").value);

    // ä¼˜å…ˆè‡ªå®šä¹‰ï¼Œå¦åˆ™ç”¨é¢„è®¾
    const custom = $("#single_prompt").value.trim();
    if (custom) fd.append("rtsp_system_prompt", custom);
    fd.append("vlm_preset", $("#single_preset").value);

    fd.append("cut_window_sec", String(cutwin));
    fd.append("alpha_bgr",     String(alpha));
    fd.append("topk_frames",   String(topk));

    fd.append("vlm_event_min_level", $("#single_minlvl").value || "LOW");
    fd.append("rtsp_cut_number", $("#single_cutnum").value || "1");

    setStatus("å¯åŠ¨ singleâ€¦");
    try{
      const r = await fetch("/security/single_start",{method:"POST", body:fd});
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.error || "å¯åŠ¨å¤±è´¥");

      // ç»‘å®šåˆ«å
      const url = $("#single_rtsp").value.trim();
      const alias = $("#single_alias").value.trim();
      if (url && alias) aliasMap[url] = alias;

      await refreshJobs(false);
      $("#jobsSelect").value = j.job_id;
      onSelectJobChanged();
      setStatus(`single å¯åŠ¨æˆåŠŸï¼Œjob=${j.job_id}`);
    }catch(e){ setStatus(e.message||"è¯·æ±‚å¤±è´¥", false); }
  });

  // ======= è½®è¯¢å¯åŠ¨ =======  
  const pollingList = $("#pollingList");
  function makeRow(idx){
    const wrap = document.createElement("div");
    wrap.className="card";
    wrap.style.padding="8px";
    wrap.innerHTML = `
      <div class="row"><label>RTSP #${idx+1}</label><input type="text" class="pl_url" placeholder="rtsp://..." required></div>
      <div class="grid3">
        <input type="text" class="pl_alias" placeholder="åˆ«å(å‰ç«¯)">
        <select class="pl_preset">
          <option value="">(å¯é€‰) é¢„è®¾</option>
          <option value="FACTORY_SECURITY">å·¥å‚å®‰é˜²</option>
          <option value="RESIDENTIAL_SECURITY">å°åŒºå®‰é˜²</option>
          <option value="OFFICE_PRODUCTIVITY_COMPLIANT">åŠå…¬åŒºç§©åºä¸å ç”¨</option>
          <option value="CONSTRUCTION_PPE">æ–½å·¥ç°åœº PPE ä¸ä¸‰è¿</option>
          <option value="RETAIL_LOSS_PREVENTION">é›¶å”®é—¨åº— é˜²æŸä¸é™ˆåˆ—åˆè§„</option>
          <option value="TRAFFIC_INTERSECTION">äº¤é€šè·¯å£ æ€åŠ¿ä¸é£é™©</option>
          <option value="WAREHOUSE_SAFETY">ä»“å‚¨ä½œä¸š å®‰å…¨ä¸æ•ˆç‡</option>
          <option value="LAB_DATACENTER_SAFETY">å®éªŒå®¤ä¸æœºæˆ¿ å®‰å…¨åˆè§„</option>
          <option value="MANUFACTURING_QA">ç”Ÿäº§çº¿ å¤–è§‚è´¨æ£€ä¸å·¥ä½å¼‚å¸¸</option>
          <option value="HEALTHCARE_PUBLIC_SAFETY">åŒ»ç–—å…»è€æœºæ„ å…¬å…±å®‰å…¨</option>
        </select>
        <input type="text" class="pl_prompt" placeholder="(å¯é€‰) è‡ªå®šä¹‰æç¤ºè¯">
      </div>
      <div class="row"><label>æ¯è½®åˆ‡ç‰‡æ•°</label><input type="number" class="pl_cutnum" min="1" max="10" value="1" title="æ¯è½®åˆ‡ç‰‡æ•°"></div>
    `;
    return wrap;
  }
  function reindexRows(){
    [...pollingList.children].forEach((node,i)=>{
      const lab = node.querySelector("label");
      if (lab) lab.textContent = `RTSP #${i+1}`;
    });
  }
  function addRow(){ pollingList.appendChild(makeRow(pollingList.children.length)); reindexRows(); }
  $("#btnAddRow").addEventListener("click", addRow);
  $("#btnDelLast").addEventListener("click", ()=>{ if (pollingList.lastChild) pollingList.removeChild(pollingList.lastChild); reindexRows(); });
  $("#btnClearAll").addEventListener("click", ()=>{ pollingList.innerHTML=""; });

  $("#poll_backend").addEventListener("change", (e)=>{
    const v = e.target.value;
    $("#rowPollLocal").style.display = (v==="local")?"":"none";
    $("#rowPollCloud").style.display = (v==="cloud")?"":"none";
    lockTopK($("#poll_topk"), v==="local");
  });

  $("#formPolling").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const rows = [...pollingList.children];
    if (rows.length<2) { setStatus("è½®è¯¢è‡³å°‘éœ€è¦2è·¯", false); return; }
    const backend = $("#poll_backend").value;

    // æ•°å€¼é’³åˆ¶
    const cutwin = clampNumber($("#poll_cutwin").value, 4.0, 1, null);
    const alpha  = clampNumber($("#poll_alpha").value, 0.5, 0, 1);
    const topk   = clampNumber($("#poll_topk").value, 1, 1, null);

    // æ±‡æ€» streams + åˆ«åç¼“å­˜
    const streams = [];
    rows.forEach(row=>{
      const url = row.querySelector(".pl_url").value.trim();
      const alias = row.querySelector(".pl_alias").value.trim();
      const preset = row.querySelector(".pl_preset").value;
      const custom = row.querySelector(".pl_prompt").value.trim();
      const cutnum = Number(row.querySelector(".pl_cutnum").value || 1);
      if (url) {
        const prompt = custom || preset || null; // æ¯è·¯åªä¼ ä¸€ä¸ªå­—æ®µï¼šrtsp_system_prompt
        streams.push({ rtsp_url: url, rtsp_system_prompt: prompt, rtsp_cut_number: Math.max(1, Math.min(10, cutnum)) });
        if (alias) aliasMap[url] = alias;
      }
    });

    const body = {
      vlm_backend: backend,
      local_model_name: backend==="local" ? $("#poll_local_model").value : null,
      cloud_model_name: backend==="cloud" ? $("#poll_cloud_model").value : null,
      cut_window_sec: cutwin,
      alpha_bgr: alpha,
      topk_frames: topk,
      vlm_event_min_level: $("#poll_minlvl").value || "LOW",
      polling_batch_interval: Number($("#poll_interval").value || 15),
      streams
    };

    setStatus("å¯åŠ¨ pollingâ€¦");
    try{
      const r = await fetch("/security/polling_start",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.error || "å¯åŠ¨å¤±è´¥");
      pollingInterval = body.polling_batch_interval;
      await refreshJobs(false);
      $("#jobsSelect").value = j.job_id;
      onSelectJobChanged();
      setStatus(`polling å¯åŠ¨æˆåŠŸï¼Œjob=${j.job_id}`);
    }catch(e){ setStatus(e.message||"è¯·æ±‚å¤±è´¥", false); }
  });

  // ======= ç¦»çº¿ï¼šè§†é¢‘/éŸ³é¢‘ =======  
  $("#off_backend").addEventListener("change",(e)=>{
    const v=e.target.value;
    $("#rowOffLocal").style.display = (v==="local")?"":"none";
    $("#rowOffCloud").style.display = (v==="cloud")?"":"none";
  });

  $("#formOffline").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const fd = new FormData();
    const f = $("#off_file").files[0];
    const path = $("#off_path").value.trim();
    if (f) fd.append("file", f);
    if (!f && path) fd.append("file_path", path);
    if (!f && !path) { setStatus("è¯·é€‰æ‹©æ–‡ä»¶æˆ–å¡«å†™æœ¬åœ°è·¯å¾„", false); return; }

    // æ•°å€¼é’³åˆ¶
    const cutwin = clampNumber($("#off_cutwin").value, 6.0, 1, null);
    const alpha  = clampNumber($("#off_alpha").value, 0.5, 0, 1);
    const topk   = clampNumber($("#off_topk").value, 3, 1, null);
    fd.append("cut_window_sec", String(cutwin));
    fd.append("alpha_bgr",     String(alpha));
    fd.append("topk_frames",   String(topk));

    const name = f ? f.name : path;
    const {isVideo,isAudio} = detectMediaKindByName(name);

    if (isVideo) {
      fd.append("system_prompt", $("#off_sys_prompt").value || "");
      const backend = $("#off_backend").value;
      fd.append("vlm_backend", backend);
      if (backend==="local") fd.append("local_model_name", $("#off_local_model").value);
      if (backend==="cloud") fd.append("cloud_model_name", $("#off_cloud_model").value);
    } else {
      // éŸ³é¢‘ï¼šVLMé¡¹å¯¹åç«¯æ— æ„ä¹‰ï¼Œä½†å­—æ®µå­˜åœ¨ä¹Ÿä¸å½±å“
      fd.append("vlm_backend", "local");
    }

    setStatus("å¯åŠ¨ç¦»çº¿ä»»åŠ¡â€¦");
    try{
      const r = await fetch("/offline/vision_describe_start",{method:"POST", body:fd});
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.error || "å¯åŠ¨å¤±è´¥");
      await refreshJobs(false);
      $("#jobsSelect").value = j.job_id;
      onSelectJobChanged();
      setStatus(`ç¦»çº¿ä»»åŠ¡å·²å¯åŠ¨ï¼ˆ${j.mode}ï¼‰ï¼Œjob=${j.job_id}`);
    }catch(e){ setStatus(e.message||"è¯·æ±‚å¤±è´¥", false); }
  });

  // ======= è¿è¡ŒæœŸæ§åˆ¶ =======  
  $("#btnPause").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    const r = await fetch(`/security/${encodeURIComponent(activeJobId)}/pause`,{method:"POST"});
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"æš‚åœå¤±è´¥", false);
    setStatus(`å·²æš‚åœ job=${activeJobId}`);
  });
  $("#btnResume").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    const r = await fetch(`/security/${encodeURIComponent(activeJobId)}/resume`,{method:"POST"});
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"æ¢å¤å¤±è´¥", false);
    setStatus(`å·²æ¢å¤ job=${activeJobId}`);
  });
  $("#btnStopJob").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    const r = await fetch(`/job/${encodeURIComponent(activeJobId)}/stop`,{method:"POST"});
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"åœæ­¢å¤±è´¥", false);
    setStatus(`å·²åœæ­¢ job=${activeJobId}`); closeSSE(); await refreshJobs(false);
  });

  // è½®è¯¢ä¸“ç”¨ï¼šæ”¹é—´éš”ã€æ–°å¢/åˆ é™¤/æ›´æ–°æµ  
  $("#btnSetInterval").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    if (!isPollingMode(activeMode)) return setStatus("å½“å‰éè½®è¯¢æ¨¡å¼", false);
    const v = clampNumber($("#ctl_interval").value, 15, 10, null);
    const fd = new FormData(); fd.append("polling_batch_interval", String(v));
    const r = await fetch(`/security/${encodeURIComponent(activeJobId)}/polling/update_interval`,{method:"POST", body:fd});
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"è®¾ç½®å¤±è´¥", false);
    pollingInterval = v; renderInfoBar();
    setStatus(`å·²è®¾ç½®è½®è¯¢é—´éš”=${v}s`);
  });

  $("#btnAddStream").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    if (!isPollingMode(activeMode)) return setStatus("å½“å‰éè½®è¯¢æ¨¡å¼", false);
    const url = $("#ctl_add_url").value.trim();
    if (!url) return setStatus("è¯·è¾“å…¥URL", false);
    const alias = $("#ctl_add_alias").value.trim();
    const body = {
      rtsp_url: url,
      rtsp_system_prompt: $("#ctl_add_prompt").value.trim() || null,
      rtsp_cut_number: Number($("#ctl_add_cutnum").value || 1)
    };
    const r = await fetch(`/security/${encodeURIComponent(activeJobId)}/polling/add_stream`,{
      method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"æ–°å¢å¤±è´¥", false);
    if (alias) aliasMap[url] = alias;
    setStatus(`å·²æ–°å¢æµï¼Œå½“å‰å…± ${j.count} è·¯`);
  });

  $("#btnDelStream").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    if (!isPollingMode(activeMode)) return setStatus("å½“å‰éè½®è¯¢æ¨¡å¼", false);
    const url = $("#ctl_del_url").value.trim();
    if (!url) return setStatus("è¯·è¾“å…¥URL", false);
    const fd = new FormData(); fd.append("rtsp_url", url);
    const r = await fetch(`/security/${encodeURIComponent(activeJobId)}/polling/remove_stream`,{method:"POST", body:fd});
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"åˆ é™¤å¤±è´¥", false);
    delete aliasMap[url];
    setStatus(`å·²åˆ é™¤ï¼Œå½“å‰å…± ${j.count} è·¯`);
  });

  $("#btnUpdStream").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    const body = {
      old_rtsp_url: $("#ctl_upd_old").value.trim() || null,
      index: ($("#ctl_upd_idx").value==="" ? null : Number($("#ctl_upd_idx").value)),
      item: {
        rtsp_url: $("#ctl_upd_newurl").value.trim(),
        rtsp_system_prompt: $("#ctl_upd_prompt").value.trim() || null,
        rtsp_cut_number: ($("#ctl_upd_cutnum").value==="" ? 1 : Number($("#ctl_upd_cutnum").value))
      }
    };
    if (!body.item.rtsp_url) return setStatus("æ–°URLä¸èƒ½ä¸ºç©º", false);
    const alias = $("#ctl_upd_alias").value.trim();
    const r = await fetch(`/security/${encodeURIComponent(activeJobId)}/update_stream`,{
      method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"æ›´æ–°å¤±è´¥", false);
    if (alias) aliasMap[body.item.rtsp_url] = alias;
    if (j.old) delete aliasMap[j.old];
    setStatus(`å·²æ›´æ–°æµï¼š${(j.index!=null)?`index=${j.index}`:"å•æµ"} â†’ ${j.new}`);
  });

  // ç»Ÿè®¡ / å…¨åœ  
  $("#btnStats").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    const r = await fetch(`/job/${encodeURIComponent(activeJobId)}/stats`);
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"è·å–ç»Ÿè®¡å¤±è´¥", false);
    setStatus(`ç»Ÿè®¡ï¼š${JSON.stringify(j.stats)}`);
  });
  $("#btnResetStats").addEventListener("click", async ()=>{
    if (!activeJobId) return setStatus("è¯·é€‰æ‹© Job", false);
    const r = await fetch(`/job/${encodeURIComponent(activeJobId)}/stats/reset`,{method:"POST"});
    const j = await r.json(); if(!r.ok||!j.ok) return setStatus(j.error||"é‡ç½®å¤±è´¥", false);
    setStatus("å·²é‡ç½®ç»Ÿè®¡");
  });
  $("#btnStopAll").addEventListener("click", async ()=>{
    const r = await fetch("/stop",{method:"POST"}); const j = await r.json();
    if (!r.ok || !j.ok) return setStatus(j.error||"å…¨åœå¤±è´¥", false);
    setStatus("å·²åœæ­¢å…¨éƒ¨ä»»åŠ¡"); closeSSE(); refreshJobs(false); clearRuntimeCounters(); clearEvents();
  });

  // åˆå§‹ï¼šé»˜è®¤ä¸¤è¡Œè½®è¯¢è¾“å…¥  
  (function init(){
    addRow(); addRow();
    refreshJobs(false);
    // åˆå§‹åŒ– topk é”å®š
    lockTopK($("#single_topk"), true);   // é»˜è®¤æœ¬åœ°
    lockTopK($("#poll_topk"), true);
    lockTopK($("#off_topk"), true);
  })();
})();
</script>
</body>
</html>
